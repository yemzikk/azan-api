<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Prayer Times Widget | AzanTimes.in</title>

    <!-- Stylesheets -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background: linear-gradient(
          135deg,
          #0f4c3a 0%,
          #1a5f4a 50%,
          #2d8659 100%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .widget-container {
        background: linear-gradient(
          135deg,
          rgba(31, 75, 62, 0.95),
          rgba(26, 95, 74, 0.95)
        );
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 12px 16px;
        width: 100%;
        max-width: 300px;
        max-height: 150px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.6s ease-out;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 8px;
      }

      /* Desktop Widget Mode */
      @media (min-width: 641px) and (max-width: 500px) {
        .widget-container {
          max-width: 300px;
          max-height: 150px;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .icon-wrapper {
        display: none;
      }

      .date-display {
        font-size: 11px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.2;
        letter-spacing: -0.2px;
      }

      .location-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 10px;
        font-weight: 500;
        margin-top: -4px;
      }

      .location-display i {
        font-size: 9px;
        opacity: 0.9;
      }

      .next-prayer {
        background: rgba(255, 255, 255, 0.98);
        color: #1a5f4a;
        padding: 10px 12px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }

      .next-prayer .label {
        font-size: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .prayer-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .prayer-name {
        font-size: 16px;
        font-weight: 800;
        color: #0f4c3a;
        letter-spacing: -0.3px;
      }

      .prayer-time {
        font-size: 16px;
        font-weight: 700;
        color: #1a5f4a;
      }

      .countdown {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 8px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }

      .countdown i {
        font-size: 7px;
      }

      .countdown-time {
        font-weight: 800;
        color: #b45309;
      }

      /* Azan Animation Overlay */
      .azan-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          #0f4c3a 0%,
          #1a5f4a 50%,
          #2d8659 100%
        );
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 1s ease-out;
      }

      .azan-overlay.active {
        display: flex;
      }

      .azan-content {
        text-align: center;
        color: white;
        animation: scaleIn 1s ease-out;
        padding: 15px;
        max-width: 300px;
        max-height: 300px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .mosque-icon {
        font-size: 50px;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 10px;
        animation: pulse 2s ease-in-out infinite;
        filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3));
      }

      .azan-text {
        font-size: 18px;
        font-weight: 800;
        margin-bottom: 8px;
        letter-spacing: 1px;
        text-transform: uppercase;
        background: linear-gradient(45deg, #ffffff, #fbbf24, #ffffff);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradientShift 3s ease infinite;
        text-shadow: 0 0 40px rgba(251, 191, 36, 0.5);
      }

      .prayer-name-large {
        font-size: 32px;
        font-weight: 900;
        margin-bottom: 8px;
        color: #fbbf24;
        letter-spacing: 2px;
        animation: glow 2s ease-in-out infinite;
        text-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }

      .azan-time {
        font-size: 20px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0;
      }

      .rings {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      .ring {
        position: absolute;
        border: 3px solid rgba(251, 191, 36, 0.3);
        border-radius: 50%;
        animation: ripple 3s ease-out infinite;
      }

      .ring:nth-child(1) {
        width: 120px;
        height: 120px;
        animation-delay: 0s;
      }

      .ring:nth-child(2) {
        width: 180px;
        height: 180px;
        animation-delay: 1s;
      }

      .ring:nth-child(3) {
        width: 240px;
        height: 240px;
        animation-delay: 2s;
      }

      .particles {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(251, 191, 36, 0.8);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.8);
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      @keyframes gradientShift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      @keyframes glow {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      @keyframes ripple {
        0% {
          transform: scale(0.8);
          opacity: 1;
        }
        100% {
          transform: scale(2);
          opacity: 0;
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0) translateX(0);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100vh) translateX(50px);
          opacity: 0;
        }
      }

      @media (max-width: 640px) {
        .mosque-icon {
          font-size: 80px;
        }

        .azan-text {
          font-size: 32px;
        }

        .prayer-name-large {
          font-size: 48px;
        }

        .azan-time {
          font-size: 24px;
        }
      }

      .loading {
        color: #ffffff;
        font-size: 15px;
        font-weight: 500;
      }

      .loading-dots {
        display: inline-block;
        margin-left: 4px;
      }

      .loading-dots span {
        animation: dotBlink 1.4s infinite;
        opacity: 0;
      }

      .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dotBlink {
        0%,
        20% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 12px;
        }

        .widget-container {
          padding: 24px;
          max-width: 100%;
          border-radius: 20px;
          min-height: 200px;
        }

        .date-display {
          font-size: 15px;
        }

        .location-display {
          font-size: 12px;
          gap: 5px;
        }

        .next-prayer {
          padding: 18px 20px;
        }

        .prayer-name,
        .prayer-time {
          font-size: 20px;
        }

        .countdown {
          font-size: 12px;
          padding: 7px 14px;
        }
      }

      /* Small mobile devices */
      @media (max-width: 380px) {
        .widget-container {
          padding: 20px;
          border-radius: 18px;
        }

        .date-display {
          font-size: 14px;
        }

        .location-display {
          font-size: 11px;
        }

        .prayer-name,
        .prayer-time {
          font-size: 18px;
        }

        .countdown {
          font-size: 11px;
          padding: 6px 12px;
        }
      }

      /* Tablet landscape and desktop widget mode */
      @media (min-width: 641px) and (max-width: 1024px) {
        .widget-container {
          max-width: 450px;
        }
      }

      /* Large screens */
      @media (min-width: 1025px) {
        .widget-container {
          max-width: 480px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Azan Animation Overlay -->
    <div id="azan-overlay" class="azan-overlay">
      <div class="rings">
        <div class="ring"></div>
        <div class="ring"></div>
        <div class="ring"></div>
      </div>
      <div class="particles" id="particles"></div>
      <div class="azan-content">
        <div class="mosque-icon">
          <i class="fas fa-mosque"></i>
        </div>
        <div class="azan-text">It's Time for</div>
        <div class="prayer-name-large" id="azan-prayer-name">Asr</div>
        <div class="azan-time" id="azan-prayer-time">3:33 PM</div>
      </div>
    </div>

    <div class="widget-container">
      <div class="icon-wrapper">
        <i class="fas fa-calendar-day"></i>
      </div>

      <div id="date-display" class="date-display">
        <div class="loading">
          Loading<span class="loading-dots"
            ><span>.</span><span>.</span><span>.</span></span
          >
        </div>
      </div>

      <div id="location-display" class="location-display" style="display: none">
        <i class="fas fa-map-marker-alt"></i>
        <span id="location-name">Ernakulam Shafi</span>
      </div>

      <div id="next-prayer" class="next-prayer" style="display: none">
        <div class="label">
          <span>Next Prayer</span>
          <div id="countdown" class="countdown">
            <i class="fas fa-clock"></i>
            <span class="countdown-time" id="countdown-time">2h 15m</span>
          </div>
        </div>
        <div class="prayer-info">
          <span class="prayer-name" id="prayer-name">Asr</span>
          <span class="prayer-time" id="prayer-time">3:33 PM</span>
        </div>
      </div>
    </div>

    <script>
      // Get query parameter from URL
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Format date to "Monday, November 3, 2025"
      function formatDate(dateString) {
        if (!dateString) return "Invalid Date";

        try {
          // Parse DD-MM-YYYY format from API
          const parts = dateString.toString().split("-");
          if (parts.length === 3) {
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
            const year = parseInt(parts[2], 10);

            // Create date at noon to avoid timezone issues
            const date = new Date(year, month, day, 12, 0, 0);

            if (!isNaN(date.getTime())) {
              const options = {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              };
              return date.toLocaleDateString("en-US", options);
            }
          }

          return "Invalid Date";
        } catch (error) {
          console.error("Date parsing error:", error);
          return "Invalid Date";
        }
      } // Format time to 12-hour format
      function formatTime(time) {
        if (!time) return "";
        // If already in 12-hour format, return as is
        if (time.includes("AM") || time.includes("PM")) {
          return time;
        }
        // Parse 24-hour format
        const [hours, minutes] = time.split(":").map(Number);
        const period = hours >= 12 ? "PM" : "AM";
        const displayHours = hours % 12 || 12;
        return `${displayHours}:${minutes
          .toString()
          .padStart(2, "0")} ${period}`;
      }

      // Parse time string to minutes
      function timeToMinutes(timeString) {
        const [time, period] = timeString.split(" ");
        const [hours, minutes] = time.split(":").map(Number);
        let totalMinutes = hours * 60 + minutes;

        if (period === "PM" && hours !== 12) totalMinutes += 12 * 60;
        if (period === "AM" && hours === 12) totalMinutes -= 12 * 60;

        return totalMinutes;
      }

      // Find next prayer from prayer times
      function findNextPrayer(prayerData) {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();

        const prayers = [
          { name: "Fajr", time: formatTime(prayerData.subh) },
          { name: "Sunrise", time: formatTime(prayerData.sunrise) },
          { name: "Dhuhr", time: formatTime(prayerData.duhr) },
          { name: "Asr", time: formatTime(prayerData.asar) },
          { name: "Maghrib", time: formatTime(prayerData.maghrib) },
          { name: "Isha", time: formatTime(prayerData.isha) },
        ];

        // Find the next upcoming prayer
        for (let prayer of prayers) {
          const prayerMinutes = timeToMinutes(prayer.time);

          if (prayerMinutes > currentTime) {
            document.getElementById("prayer-name").textContent = prayer.name;
            document.getElementById("prayer-time").textContent = prayer.time;

            // Start countdown
            startCountdown(prayerMinutes);
            return;
          }
        }

        // If no prayer found today, show Fajr for tomorrow
        document.getElementById("prayer-name").textContent = prayers[0].name;
        document.getElementById("prayer-time").textContent =
          prayers[0].time + " (Tomorrow)";

        // Calculate minutes until tomorrow's Fajr
        const tomorrowFajr = timeToMinutes(prayers[0].time) + 24 * 60;
        startCountdown(tomorrowFajr);
      }

      // Countdown timer
      let countdownInterval;
      let azanTimeout;

      function startCountdown(targetMinutes) {
        // Clear any existing countdown
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }

        function updateCountdown() {
          const now = new Date();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          let remainingMinutes = targetMinutes - currentMinutes;

          // Handle tomorrow's prayer
          if (remainingMinutes < 0) {
            remainingMinutes += 24 * 60;
          }

          const hours = Math.floor(remainingMinutes / 60);
          const minutes = remainingMinutes % 60;

          let countdownText = "";
          if (hours > 0) {
            countdownText = `${hours}h ${minutes}m`;
          } else if (minutes > 0) {
            countdownText = `${minutes}m`;
          } else {
            countdownText = "Now";
            // Show azan animation when countdown reaches zero
            showAzanAnimation();
            // Reload prayer times after animation
            setTimeout(() => loadPrayerTimes(), 62000); // 1 minute + 2 seconds
          }

          document.getElementById("countdown-time").textContent = countdownText;
        }

        // Update immediately
        updateCountdown();

        // Update every minute
        countdownInterval = setInterval(updateCountdown, 60000);
      }

      // Show azan animation
      function showAzanAnimation() {
        const overlay = document.getElementById("azan-overlay");
        const prayerName = document.getElementById("prayer-name").textContent;
        const prayerTime = document.getElementById("prayer-time").textContent;

        // Update animation content
        document.getElementById("azan-prayer-name").textContent = prayerName;
        document.getElementById("azan-prayer-time").textContent = prayerTime;

        // Create floating particles
        createParticles();

        // Show overlay
        overlay.classList.add("active");

        // Play sound if available
        try {
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE"
          );
          audio.volume = 0.3;
          audio.play().catch(() => {});
        } catch (e) {}

        // Hide after 1 minute
        if (azanTimeout) {
          clearTimeout(azanTimeout);
        }
        azanTimeout = setTimeout(() => {
          overlay.classList.remove("active");
        }, 60000); // 60 seconds
      }

      // Create floating particles
      function createParticles() {
        const particlesContainer = document.getElementById("particles");
        particlesContainer.innerHTML = ""; // Clear existing particles

        for (let i = 0; i < 50; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = Math.random() * 100 + "%";
          particle.style.animationDelay = Math.random() * 6 + "s";
          particle.style.animationDuration = Math.random() * 3 + 4 + "s";
          particlesContainer.appendChild(particle);
        }
      }

      // Fetch prayer times from API
      async function loadPrayerTimes() {
        try {
          // Get location from query parameter - required
          const location = getQueryParam("q");

          if (!location) {
            throw new Error("Location parameter (?q=) is required");
          }

          // Update location display
          const locationName = location.replace(/_/g, " ");
          document.getElementById("location-name").textContent = locationName;

          // Fetch today's prayer times
          const response = await fetch(
            `https://api.azantimes.in/v1/timesheets/${location}/today.json`
          );

          if (!response.ok) {
            throw new Error(`Failed to fetch prayer times: ${response.status}`);
          }

          const data = await response.json();

          // Update date display
          document.getElementById("date-display").textContent = formatDate(
            data.date
          );

          // Show location and prayer info
          document.getElementById("location-display").style.display = "flex";
          document.getElementById("next-prayer").style.display = "block";

          // Find and display next prayer
          findNextPrayer(data);

          console.log("‚úÖ Prayer times loaded successfully");
        } catch (error) {
          console.error("Error loading prayer times:", error);

          // Show error state
          document.getElementById("date-display").innerHTML =
            '<div style="color: #ffcccc; font-size: 15px;">Please add ?q=Location_Name to URL</div>';
        }
      }

      // Initialize widget
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          loadPrayerTimes();
        }, 500);
      });

      // Update prayer times when page becomes visible
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          console.log("üì± Page became visible, updating prayer times...");
          loadPrayerTimes();
        }
      });

      // Update prayer times when window gets focus (useful for desktop widgets)
      window.addEventListener("focus", () => {
        console.log("üîç Window focused, updating prayer times...");
        loadPrayerTimes();
      });
    </script>
  </body>
</html>
